<script>
  // 1) Хелпери показу/ховання екранів
  function showApp(username) {
    const authScreen = document.getElementById('authScreen');
    const mainApp = document.getElementById('mainApp');
    const userKeyDisplay = document.getElementById('userKeyDisplay');

    authScreen.classList.add('hidden');
    mainApp.classList.remove('opacity-0', 'pointer-events-none');
    if (userKeyDisplay) userKeyDisplay.textContent = `Ключ: ${username}`;
  }

  function showAuth(message) {
    const authMessage = document.getElementById('authMessage');
    if (authMessage && message) authMessage.textContent = message;

    const authScreen = document.getElementById('authScreen');
    const mainApp = document.getElementById('mainApp');

    authScreen.classList.remove('hidden');
    mainApp.classList.add('opacity-0', 'pointer-events-none');
  }

  // 2) Logout має бути ГЛОБАЛЬНИМ, бо у тебе onclick="logout()"
  window.logout = function logout() {
    localStorage.removeItem('st_user');
    localStorage.removeItem('st_pass');
    showAuth('Ви вийшли');
  };

  // 3) Логін (поки що локально, без Firebase): створити/увійти
  function setLoading(isLoading) {
    const btn = document.getElementById('loginBtn');
    const txt = document.getElementById('loginBtnText');
    if (!btn || !txt) return;

    btn.disabled = isLoading;
    txt.textContent = isLoading ? 'Зачекайте…' : 'Увійти або Створити';
  }

  function normalizeUsername(s) {
    return (s || '').trim().toLowerCase();
  }

  function handleLogin() {
    const uEl = document.getElementById('usernameInput');
    const pEl = document.getElementById('passwordInput');
    const authMessage = document.getElementById('authMessage');

    const username = normalizeUsername(uEl?.value);
    const password = (pEl?.value || '').trim();

    if (!username || !password) {
      if (authMessage) authMessage.textContent = 'Введіть логін і пароль';
      return;
    }

    setLoading(true);

    // Симуляція "create or login" (локальне сховище).
    // Якщо у тебе Firebase — заміниш цей блок на реальну перевірку в Firestore/Auth.
    const savedPass = localStorage.getItem('st_pass_' + username);

    if (!savedPass) {
      // створюємо "акаунт"
      localStorage.setItem('st_pass_' + username, password);
      localStorage.setItem('st_user', username);
      localStorage.setItem('st_pass', password);
      showApp(username);
    } else {
      // логін
      if (savedPass !== password) {
        if (authMessage) authMessage.textContent = 'Невірний пароль';
        setLoading(false);
        return;
      }
      localStorage.setItem('st_user', username);
      localStorage.setItem('st_pass', password);
      showApp(username);
    }

    setLoading(false);
  }

  // 4) Ініціалізація після завантаження DOM
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('loginBtn');
    const uEl = document.getElementById('usernameInput');
    const pEl = document.getElementById('passwordInput');

    if (!btn || !uEl || !pEl) {
      console.error('Не знайдені елементи логіну (перевір id).');
      return;
    }

    btn.addEventListener('click', handleLogin);

    // Enter в полі пароля
    pEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') handleLogin();
    });

    // Автовхід якщо є сесія
    const savedUser = localStorage.getItem('st_user');
    if (savedUser) showApp(savedUser);
  });
</script>
