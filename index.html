<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StreamTrack - Cloud Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --apple-bg: #000000;
            --apple-card: #1c1c1e;
            --apple-accent: #0071e3;
        }
        body {
            background-color: var(--apple-bg);
            color: #f5f5f7;
            font-family: 'Inter', -apple-system, sans-serif;
            letter-spacing: -0.01em;
            overflow-x: hidden;
            touch-action: manipulation;
        }
        .glass {
            background: rgba(28, 28, 30, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .card-row {
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
            -webkit-tap-highlight-color: transparent;
        }
        .card-row:active {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(0.98);
        }
        .login-screen {
            background: radial-gradient(circle at center, #111 0%, #000 100%);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="min-h-screen">

    <!-- –ï–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó -->
    <div id="authScreen" class="fixed inset-0 z-[1000] login-screen flex items-center justify-center p-4">
        <div class="glass max-w-sm w-full p-8 rounded-3xl text-center shadow-2xl">
            <h1 class="text-3xl font-black mb-1 tracking-tighter text-white">StreamTrack</h1>
            <p id="authMessage" class="text-blue-500 text-[10px] font-bold uppercase tracking-widest mb-8">–•–º–∞—Ä–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è</p>

            <div class="space-y-3">
                <input type="text" id="usernameInput" placeholder="–õ–æ–≥—ñ–Ω (—ñ–º'—è)"
                    class="w-full h-12 bg-white/5 border border-white/10 rounded-xl px-4 text-center text-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all text-white placeholder:text-gray-600">

                <input type="password" id="passwordInput" placeholder="–ü–∞—Ä–æ–ª—å"
                    class="w-full h-12 bg-white/5 border border-white/10 rounded-xl px-4 text-center text-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all text-white placeholder:text-gray-600">

                <button id="loginBtn" type="button" class="w-full h-14 bg-blue-600 text-white font-black rounded-2xl active:bg-blue-700 disabled:bg-gray-700 transition-all uppercase text-xs tracking-widest mt-4 flex items-center justify-center">
                    <span id="loginBtnText">–£–≤—ñ–π—Ç–∏ –∞–±–æ –°—Ç–≤–æ—Ä–∏—Ç–∏</span>
                </button>
            </div>
            <p class="text-[9px] text-gray-500 mt-6 leading-relaxed uppercase font-bold">
                –Ø–∫—â–æ –≤–∏ –≤–ø–µ—Ä—à–µ ‚Äî —Å–∏—Å—Ç–µ–º–∞ –∑–∞–ø–∞–º'—è—Ç–∞—î —Ü–µ–π –ø–∞—Ä–æ–ª—å –¥–ª—è –≤–∫–∞–∑–∞–Ω–æ–≥–æ –ª–æ–≥—ñ–Ω–∞.
            </p>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ -->
    <div id="mainApp" class="max-w-5xl mx-auto px-4 py-8 opacity-0 pointer-events-none transition-opacity duration-500">
        <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
            <div class="flex items-center justify-between w-full md:w-auto">
                <div>
                    <h1 class="text-3xl font-black tracking-tighter bg-gradient-to-r from-white to-gray-500 bg-clip-text text-transparent">StreamTrack</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span id="syncStatus" class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></span>
                        <p id="userKeyDisplay" class="text-gray-500 text-[10px] font-bold uppercase tracking-widest"></p>
                    </div>
                </div>
                <div class="md:hidden flex items-center gap-2">
                    <button onclick="shareList()" class="glass px-3 py-2 rounded-lg text-[9px] font-black text-blue-400 uppercase tracking-widest">–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—å</button>
                    <button onclick="logout()" class="glass px-3 py-2 rounded-lg text-[9px] font-black text-red-400 uppercase tracking-widest">–í–∏–π—Ç–∏</button>
                </div>
            </div>
            <div class="hidden md:flex items-center gap-2">
            <button onclick="shareList()" class="glass px-4 py-2 rounded-lg text-[10px] font-black hover:bg-blue-500/20 text-blue-400 transition uppercase tracking-widest">–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—å</button>
            <button onclick="logout()" class="glass px-4 py-2 rounded-lg text-[10px] font-black hover:bg-red-500/20 text-red-400 transition uppercase tracking-widest">–í–∏–π—Ç–∏</button>
        </div>
        </header>

        <!-- Search -->
        <div class="relative mb-8">
            <input type="text" id="searchInput" placeholder="–ó–Ω–∞–π—Ç–∏ —Å–µ—Ä—ñ–∞–ª —É TVMaze..."
                class="w-full h-14 bg-white/5 border border-white/10 rounded-2xl pl-12 pr-4 focus:ring-2 focus:ring-blue-500 focus:outline-none text-base text-white transition-all">
            <div class="absolute inset-y-0 left-4 flex items-center pointer-events-none text-gray-500">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="2.5"></path></svg>
            </div>
            <div id="searchResults" class="absolute top-full left-0 right-0 glass mt-2 rounded-2xl shadow-2xl z-[100] hidden overflow-hidden border border-white/20 max-h-80 overflow-y-auto"></div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-6 border-b border-white/5 mb-6 overflow-x-auto no-scrollbar">
            <button id="tab-watching" class="pb-3 border-b-2 border-blue-500 text-blue-500 text-[10px] font-black uppercase tracking-widest">–î–∏–≤–ª—é—Å—è</button>
            <button id="tab-planning" class="pb-3 border-b-2 border-transparent text-gray-500 text-[10px] font-black uppercase tracking-widest">–ü–ª–∞–Ω–∏</button>
            <button id="tab-watched" class="pb-3 border-b-2 border-transparent text-gray-500 text-[10px] font-black uppercase tracking-widest">–ê—Ä—Ö—ñ–≤</button>
        </div>

        <div id="gallery" class="flex flex-col gap-3"></div>
        <div id="emptyState" class="hidden text-center py-20 text-gray-600 uppercase font-bold text-[10px] tracking-widest">–ü–æ–∫–∏ —â–æ —Ç—É—Ç –ø–æ—Ä–æ–∂–Ω—å–æ</div>
    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black/95 z-[200] hidden items-end md:items-center justify-center p-0 md:p-4 backdrop-blur-md">
        <div class="glass w-full max-w-2xl max-h-[90vh] rounded-t-3xl md:rounded-3xl overflow-hidden flex flex-col translate-y-full transition-transform duration-300" id="modalContainer">
            <div class="p-6 md:p-8 overflow-y-auto no-scrollbar" id="modalContent"></div>
            <div class="p-6 border-t border-white/5">
                <button onclick="closeModal()" class="w-full py-4 bg-white text-black font-black rounded-2xl active:scale-95 transition-all text-[11px] uppercase tracking-widest">–ó–∞–∫—Ä–∏—Ç–∏</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =============================
        // FIX: GitHub Pages –ù–ï –º–∞—î __firebase_config / __app_id / __initial_auth_token.
        // –¢—É—Ç —Ç—Ä–µ–±–∞ –Ø–í–ù–û –≤—Å—Ç–∞–≤–∏—Ç–∏ firebaseConfig —Å–≤–æ–≥–æ –ø—Ä–æ—î–∫—Ç—É.
        //
        // –Ø–∫ –≤–∑—è—Ç–∏:
        // Firebase Console ‚Üí Project settings ‚Üí Your apps (Web) ‚Üí Firebase SDK snippet ‚Üí Config
        // =============================
        const firebaseConfig = {
            apiKey: "AIzaSyBI72wYVkWPnU6IShQA0GzNv2qxkSwPjxc",
            authDomain: "raf-serials.firebaseapp.com",
            projectId: "raf-serials",
            storageBucket: "raf-serials.firebasestorage.app",
            messagingSenderId: "908671765741",
            appId: "1:908671765741:web:bc0573e464c69ec90d90e4",
            measurementId: "G-4RX35LRNFF"
        };

        const appId = "streamtrack-v2"; // –±—É–¥—å-—è–∫–∏–π —Ä—è–¥–æ–∫, –∞–ª–µ —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π

        // --- UI status ---
        function showStatus(m, c) {
            const el = document.getElementById('authMessage');
            if (!el) return;
            el.innerText = m;
            el.style.color = c === 'red' ? '#ef4444' : '#3b82f6';
        }


        // --- Helpers (security + UX) ---
        const getParam = (k) => new URLSearchParams(window.location.search).get(k);

        async function sha256Hex(str) {
            const enc = new TextEncoder().encode(str);
            const buf = await crypto.subtle.digest('SHA-256', enc);
            return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function cacheKey(username) { return `streamtrack_cache_${username}`; }
        function loadCache(username) {
            try { return JSON.parse(localStorage.getItem(cacheKey(username)) || 'null'); } catch { return null; }
        }
        function saveCache(username, data) {
            try { localStorage.setItem(cacheKey(username), JSON.stringify(data)); } catch {}
        }
        // Guard: —è–∫—â–æ –∫–æ–Ω—Ñ—ñ–≥ –Ω–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–∏–π
        if (!firebaseConfig || String(firebaseConfig.apiKey || "").startsWith("PASTE_")) {
            showStatus("–í—Å—Ç–∞–≤ firebaseConfig —É –∫–æ–¥ (–¥–∏–≤. –∫–æ–º–µ–Ω—Ç–∞—Ä —É —Å–∫—Ä–∏–ø—Ç—ñ).", "red");
            throw new Error("Missing firebaseConfig");
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let myShows = [];
        let currentTab = 'watching';
        let currentUserData = JSON.parse(localStorage.getItem('streamtrack_user'));
        const sharedUser = (getParam('shared') || '').trim().toLowerCase();
        const isReadOnly = !!sharedUser;
        if (isReadOnly && sharedUser) {
            currentUserData = { username: sharedUser, shared: true };
        }
        let isAuthReady = false;

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó Firebase (GitHub Pages: —Ç—ñ–ª—å–∫–∏ anonymous)
        const initAuth = async () => {
            try {
                await signInAnonymously(auth);
                isAuthReady = true;
            } catch (e) {
                console.error("Auth init error:", e);
                showStatus('–ü–æ–º–∏–ª–∫–∞ –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º', 'red');
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user && currentUserData) {
                unlockApp();
                setupSync();
            }
        });

        initAuth();

        // listeners
        document.getElementById('loginBtn').addEventListener('click', handleAuth);
        document.getElementById('tab-watching').addEventListener('click', () => setTab('watching'));
        document.getElementById('tab-planning').addEventListener('click', () => setTab('planning'));
        document.getElementById('tab-watched').addEventListener('click', () => setTab('watched'));
        document.getElementById('passwordInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') handleAuth();
        });

        async function handleAuth() {
            const user = document.getElementById('usernameInput').value.trim().toLowerCase();
            const pass = document.getElementById('passwordInput').value.trim();
            const btn = document.getElementById('loginBtn');
            const btnText = document.getElementById('loginBtnText');

            if (user.length < 3 || pass.length < 4) {
                showStatus('–õ–æ–≥—ñ–Ω (3+) —Ç–∞ –ü–∞—Ä–æ–ª—å (4+)', 'red');
                return;
            }

            if (!isAuthReady) {
                btnText.innerText = "–ó–∞—á–µ–∫–∞–π—Ç–µ...";
                await initAuth();
            }

            btn.disabled = true;
            btnText.innerText = "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞...";
            try {
                // Profiles: artifacts/<appId>/public/data/profiles/<username>
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'profiles', user);
                const userSnap = await getDoc(userRef);

                const passHash = 'sha256:' + await sha256Hex(pass);

                if (userSnap.exists()) {
                    const stored = String(userSnap.data().password || '');
                    const ok =
                        (stored.startsWith('sha256:') && stored === passHash) ||
                        (!stored.startsWith('sha256:') && stored === btoa(pass)); // legacy

                    if (ok) {
                        // Migrate legacy -> sha256
                        if (!stored.startsWith('sha256:')) {
                            await updateDoc(userRef, { password: passHash, migrated: Date.now() });
                        }
                        saveSession(user);
                    } else {
                        showStatus('–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å', 'red');
                    }
                } else {
                    await setDoc(userRef, {
                        username: user,
                        password: passHash,
                        created: Date.now()
                    });
                    saveSession(user);
                }
            } catch (e) {
                console.error("Firestore error:", e);
                showStatus('–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –±–∞–∑–∏', 'red');
                btnText.innerText = "–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑";
                return;
            } finally {
                btn.disabled = false;
                if (btnText.innerText === "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞...") btnText.innerText = "–£–≤—ñ–π—Ç–∏ –∞–±–æ –°—Ç–≤–æ—Ä–∏—Ç–∏";
            }
        }

        function saveSession(username) {
            currentUserData = { username };
            localStorage.setItem('streamtrack_user', JSON.stringify(currentUserData));

            if (auth.currentUser) {
                unlockApp();
                setupSync();
            } else {
                window.location.reload();
            }
        }

        // make global for onclick
        window.logout = () => {
            localStorage.removeItem('streamtrack_user');
            // If in shared mode, just go to base URL
            if (isReadOnly) {
                window.location.href = window.location.origin + window.location.pathname;
                return;
            }
            window.location.reload();
        };

        window.shareList = async () => {
            if (!currentUserData?.username) return;
            const url = new URL(window.location.href);
            url.searchParams.set('shared', currentUserData.username);
            // remove other params if any (keep only shared)
            for (const k of [...url.searchParams.keys()]) {
                if (k !== 'shared') url.searchParams.delete(k);
            }
            const shareUrl = url.toString();

            try {
                if (navigator.clipboard?.writeText) {
                    await navigator.clipboard.writeText(shareUrl);
                    alert('–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ');
                } else {
                    prompt('–°–∫–æ–ø—ñ—é–π –ø–æ—Å–∏–ª–∞–Ω–Ω—è:', shareUrl);
                }
            } catch {
                prompt('–°–∫–æ–ø—ñ—é–π –ø–æ—Å–∏–ª–∞–Ω–Ω—è:', shareUrl);
            }
        };


        function unlockApp() {
            if (!currentUserData) return;

            const authScr = document.getElementById('authScreen');
            const mainScr = document.getElementById('mainApp');

            if (authScr) authScr.classList.add('hidden');

            const userKey = document.getElementById('userKeyDisplay');
            if (userKey) userKey.innerText = `–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: ${currentUserData.username}${isReadOnly ? ' (shared)' : ''}`;

            // Hide logout/share in read-only shared view
            if (isReadOnly) {
                document.querySelectorAll('button[onclick="logout()"], button[onclick="shareList()"], div.md\:hidden.flex, div.hidden.md\:flex').forEach(el => {
                    // Keep share hidden; logout hidden
                    if (el?.innerText?.includes('–í–∏–π—Ç–∏') || el?.innerText?.includes('–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—å')) {
                        el.style.display = 'none';
                    }
                });
            }

            if (mainScr) {
                mainScr.classList.replace('opacity-0', 'opacity-100');
                mainScr.classList.remove('pointer-events-none');
            }

            setupSearch();
        }

        function setupSync() {
            if (!currentUserData || !auth.currentUser) return;

            // Fast render from cache (offline-friendly)
            const cached = loadCache(currentUserData.username);
            if (Array.isArray(cached)) {
                myShows = cached;
                renderGallery();
            }

            // collection: .../data/lists/<username>/shows/<showId>
            const showsCol = collection(db, 'artifacts', appId, 'public', 'data', 'lists', currentUserData.username, 'shows');

            onSnapshot(showsCol, (snapshot) => {
                myShows = snapshot.docs.map(d => d.data());
                saveCache(currentUserData.username, myShows);
                const sync = document.getElementById('syncStatus');
                if (sync) {
                    sync.classList.replace('bg-yellow-500', 'bg-green-500');
                    sync.classList.remove('animate-pulse');
                }
                renderGallery();
            }, (err) => {
                console.error("Sync error:", err);
            });
        }

        // --- Logic ---
        async function addShow(show) {
            if (isReadOnly) return;
            if (!currentUserData || !auth.currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'lists', currentUserData.username, 'shows', show.id.toString());
            // Auto total episodes from TVMaze (best-effort)
            let totalEpisodes = show.totalEpisodes || null;
            try {
                const epRes = await fetch(`https://api.tvmaze.com/shows/${show.id}/episodes`);
                if (epRes.ok) {
                    const eps = await epRes.json();
                    totalEpisodes = Array.isArray(eps) ? eps.length : totalEpisodes;
                }
            } catch {}

            await setDoc(docRef, {
                ...show,
                totalEpisodes: totalEpisodes || show.totalEpisodes || null,
                userStatus: '‚è≥ –£ –ø–ª–∞–Ω–∞—Ö',
                currentEpisode: 0
            });
            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('searchInput').value = '';
            vibrate(20);
        }
        window.addShowToFirebase = addShow;

        window.updateProgress = async (id, inc) => {
            if (isReadOnly) return;
            if (!auth.currentUser || !currentUserData) return;
            const show = myShows.find(s => s.id === id);
            if (!show) return;
            const val = Math.max(0, Math.min(show.totalEpisodes || 100, (show.currentEpisode || 0) + inc));
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'lists', currentUserData.username, 'shows', id.toString());
            await updateDoc(docRef, {
                currentEpisode: val,
                userStatus: val === (show.totalEpisodes || 100) ? '‚úÖ –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ' : 'üëÄ –î–∏–≤–ª—é—Å—å'
            });
            vibrate(10);
            if (document.getElementById('modal').style.display === 'flex') setTimeout(() => openModal(id), 50);
        };

        window.changeStatus = async (id, status) => {
            if (isReadOnly) return;
            if (!auth.currentUser || !currentUserData) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'lists', currentUserData.username, 'shows', id.toString());
            await updateDoc(docRef, { userStatus: status });
            closeModal();
        };

        window.deleteShow = async (id) => {
            if (isReadOnly) return;
            if (!auth.currentUser || !currentUserData || !confirm('–í–∏–¥–∞–ª–∏—Ç–∏?')) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'lists', currentUserData.username, 'shows', id.toString());
            await deleteDoc(docRef);
            closeModal();
        };

        // --- UI ---
        function renderGallery() {
            const gallery = document.getElementById('gallery');
            const empty = document.getElementById('emptyState');
            if (!gallery) return;

            const statusMap = { watching: 'üëÄ –î–∏–≤–ª—é—Å—å', planning: '‚è≥ –£ –ø–ª–∞–Ω–∞—Ö', watched: '‚úÖ –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ' };
            const filtered = myShows.filter(s => s.userStatus === statusMap[currentTab]);

            if (filtered.length === 0) {
                gallery.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            gallery.innerHTML = filtered.map(show => `
                <div class="card-row glass rounded-2xl flex items-center p-4 gap-4" onclick="openModal(${show.id})">
                    <img src="${show.image}" class="w-12 h-16 object-cover rounded-xl shrink-0">
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-sm text-white truncate">${show.name}</div>
                        <div class="text-[10px] text-gray-400 font-bold mt-1">${show.currentEpisode || 0} / ${show.totalEpisodes || '?'} –°–ï–†–Ü–ô</div>
                        <div class="w-full h-1.5 bg-white/5 rounded-full mt-2 overflow-hidden">
                            <div class="h-full bg-blue-600 transition-all duration-500" style="width: ${(((show.currentEpisode||0)/(show.totalEpisodes||100))*100)}%"></div>
                        </div>
                    </div>
                    <button onclick="event.stopPropagation(); updateProgress(${show.id}, 1)" class="w-10 h-10 flex items-center justify-center bg-blue-600/10 hover:bg-blue-600 active:scale-90 rounded-xl text-blue-500 hover:text-white font-black text-xl">+</button>
                </div>
            `).join('');
        }

        function setTab(tab) {
            currentTab = tab;
            document.querySelectorAll('button[id^="tab-"]').forEach(b => {
                b.classList.remove('border-blue-500', 'text-blue-500');
                b.classList.add('border-transparent', 'text-gray-500');
            });
            document.getElementById(`tab-${tab}`).classList.add('border-blue-500', 'text-blue-500');
            renderGallery();
        }

        window.openModal = (id) => {
            const show = myShows.find(s => s.id === id);
            if (!show) return;
            const content = document.getElementById('modalContent');
            content.innerHTML = `
                <div class="flex flex-col md:flex-row gap-6 md:gap-8">
                    <img src="${show.image}" class="w-full md:w-48 rounded-2xl shadow-2xl">
                    <div class="flex-1">
                        <h2 class="text-3xl font-black text-white mb-1 tracking-tighter">${show.name}</h2>
                        <p class="text-[10px] text-gray-500 font-bold uppercase mb-6">–†–µ–π—Ç–∏–Ω–≥: ‚≠ê ${show.imdb}</p>

                        <div class="space-y-4">
                            <div class="glass p-5 rounded-2xl text-center">
                                <p class="text-[9px] font-black text-gray-500 uppercase mb-4">–ü—Ä–æ–≥—Ä–µ—Å</p>
                                <div class="flex items-center justify-around">
                                    <button onclick="updateProgress(${show.id}, -1)" class="w-12 h-12 bg-white/5 rounded-xl text-2xl">-</button>
                                    <div class="text-3xl font-black text-white">${show.currentEpisode || 0} <span class="text-xs text-gray-600">/ ${show.totalEpisodes || '?'}</span></div>
                                    <button onclick="updateProgress(${show.id}, 1)" class="w-12 h-12 bg-blue-600 rounded-xl text-2xl shadow-lg shadow-blue-600/20">+</button>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="changeStatus(${show.id}, 'üëÄ –î–∏–≤–ª—é—Å—å')" class="p-4 glass rounded-xl text-[10px] font-black uppercase text-blue-400">–î–∏–≤–ª—é—Å—å</button>
                                <button onclick="changeStatus(${show.id}, '‚úÖ –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ')" class="p-4 glass rounded-xl text-[10px] font-black uppercase text-green-400">–ê—Ä—Ö—ñ–≤</button>
                                <button onclick="deleteShow(${show.id})" class="p-4 glass rounded-xl text-[10px] font-black uppercase text-red-500/60 col-span-2">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal').classList.replace('hidden', 'flex');
            setTimeout(() => document.getElementById('modalContainer').classList.replace('translate-y-full', 'translate-y-0'), 10);
        }

        window.closeModal = () => {
            document.getElementById('modalContainer').classList.replace('translate-y-0', 'translate-y-full');
            setTimeout(() => document.getElementById('modal').classList.replace('flex', 'hidden'), 300);
        }

        function setupSearch() {
            const input = document.getElementById('searchInput');
            const resBox = document.getElementById('searchResults');
            if (!input) return;

            input.addEventListener('input', debounce(async (e) => {
                const q = e.target.value.trim();
                if (q.length < 3) return resBox.classList.add('hidden');
                try {
                    const res = await fetch(`https://api.tvmaze.com/search/shows?q=${encodeURIComponent(q)}`);
                    const data = await res.json();
                    resBox.innerHTML = data.slice(0, 5).map(i => `
                        <div class="p-4 hover:bg-white/5 active:bg-white/10 cursor-pointer flex items-center gap-4 border-b border-white/5"
                            onclick='window.addShowToFirebase(${JSON.stringify({
                                id: i.show.id,
                                name: i.show.name,
                                image: i.show.image?.medium || 'https://via.placeholder.com/210x295',
                                imdb: i.show.rating?.average || '0',
                                totalEpisodes: 24
                            })})'>
                            <img src="${i.show.image?.medium || ''}" class="w-10 h-14 object-cover rounded-lg">
                            <div class="flex-1 min-w-0">
                                <div class="font-bold text-sm text-white truncate">${i.show.name}</div>
                                <div class="text-[9px] text-gray-500 uppercase">${i.show.status}</div>
                            </div>
                            <div class="text-blue-500 font-black text-xl">+</div>
                        </div>
                    `).join('');
                    resBox.classList.remove('hidden');
                } catch (e) { console.error("Search error", e); }
            }, 500));
        }

        function debounce(f, t) { let i; return (...a) => { clearTimeout(i); i = setTimeout(() => f(...a), t); }; }
        function vibrate(ms) { if (window.navigator.vibrate) window.navigator.vibrate(ms); }
    </script>
</body>
</html>
