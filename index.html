<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamTrack - –¢–≤—ñ–π —Å–µ—Ä—ñ–∞–ª—å–Ω–∏–π –≤—Å–µ—Å–≤—ñ—Ç</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --apple-bg: #000000;
            --apple-card: #1c1c1e;
            --apple-accent: #0071e3;
        }
        body {
            background-color: var(--apple-bg);
            color: #f5f5f7;
            font-family: 'Inter', -apple-system, sans-serif;
            letter-spacing: -0.01em;
            overflow-x: hidden;
        }
        .glass {
            background: rgba(28, 28, 30, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .card-row {
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .card-row:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.15);
        }
        .status-pill {
            font-size: 8px;
            padding: 1px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: 800;
            letter-spacing: 0.02em;
        }
        .tab-counter {
            font-size: 9px;
            margin-left: 4px;
            opacity: 0.6;
        }
        .login-screen {
            background: radial-gradient(circle at center, #111 0%, #000 100%);
        }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="min-h-screen">

    <!-- –ï–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó -->
    <div id="authScreen" class="fixed inset-0 z-[1000] login-screen flex items-center justify-center p-4">
        <div class="glass max-w-sm w-full p-8 rounded-3xl text-center shadow-2xl">
            <h1 class="text-3xl font-black mb-2 tracking-tighter">StreamTrack</h1>
            <p id="authMessage" class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-8">–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø—É</p>
            
            <div class="space-y-4">
                <input type="password" id="passwordInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                    class="w-full h-12 bg-white/5 border border-white/10 rounded-xl px-4 text-center text-xl tracking-widest focus:ring-1 focus:ring-blue-500 focus:outline-none transition-all">
                <button onclick="handleAuth()" class="w-full h-12 bg-white text-black font-black rounded-xl hover:bg-gray-200 transition uppercase text-xs tracking-widest">
                    –£–≤—ñ–π—Ç–∏
                </button>
            </div>
            <p id="authError" class="text-red-500 text-[10px] font-bold uppercase mt-4 hidden">–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –ø–∞—Ä–æ–ª—å</p>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ (–ø—Ä–∏—Ö–æ–≤–∞–Ω–∏–π –¥–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó) -->
    <div id="mainApp" class="max-w-5xl mx-auto px-4 py-8 opacity-0 pointer-events-none transition-opacity duration-500">
        <!-- Header -->
        <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
            <div>
                <h1 class="text-3xl font-black tracking-tighter bg-gradient-to-r from-white to-gray-500 bg-clip-text text-transparent">StreamTrack</h1>
                <p class="text-gray-500 text-[10px] font-bold uppercase tracking-widest">–¶–∏—Ñ—Ä–æ–≤–∏–π –ê—Ä—Ö—ñ–≤ –ú–µ–¥—ñ–∞</p>
            </div>
            
            <div class="flex flex-wrap items-center gap-2">
                <button onclick="exportData()" title="–ë–µ–∫–∞–ø –±–∞–∑–∏" class="glass px-3 py-2 rounded-lg text-[10px] font-black hover:bg-white/10 transition uppercase flex items-center gap-2">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" stroke-width="3"></path></svg>
                    –ë–µ–∫–∞–ø
                </button>
                <label class="glass px-3 py-2 rounded-lg text-[10px] font-black cursor-pointer hover:bg-white/10 transition uppercase flex items-center gap-2">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" stroke-width="3"></path></svg>
                    –Ü–º–ø–æ—Ä—Ç
                    <input type="file" class="hidden" onchange="importData(event)">
                </label>
                <button onclick="logout()" class="glass px-3 py-2 rounded-lg text-[10px] font-black hover:bg-red-500/20 text-red-400 border-red-500/20 transition uppercase">
                    –í–∏–π—Ç–∏
                </button>
            </div>
        </header>

        <!-- Search & Control -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-3 mb-8">
            <div class="lg:col-span-8 relative">
                <input type="text" id="searchInput" placeholder="–®–≤–∏–¥–∫–∏–π –ø–æ—à—É–∫ –Ω–æ–≤–∏—Ö —Å–µ—Ä—ñ–∞–ª—ñ–≤..." 
                    class="w-full h-10 bg-white/5 border border-white/10 rounded-lg pl-10 pr-4 focus:ring-1 focus:ring-blue-500 focus:outline-none text-sm transition-all">
                <div class="absolute inset-y-0 left-3 flex items-center pointer-events-none text-gray-500">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="2.5"></path></svg>
                </div>
                <div id="searchResults" class="absolute top-full left-0 right-0 glass mt-1 rounded-lg shadow-2xl z-[100] hidden overflow-hidden border border-white/20"></div>
            </div>
            
            <div class="lg:col-span-4">
                <select id="sortOrder" onchange="renderGallery()" class="w-full h-10 glass rounded-lg px-3 appearance-none cursor-pointer text-xs font-bold uppercase tracking-widest">
                    <option value="dateAdded">üìÖ –î–∞—Ç–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è</option>
                    <option value="newest">üì∫ –°–≤—ñ–∂—ñ —Å–µ—Ä—ñ—ó</option>
                    <option value="alphabet">üî§ –ê–ª—Ñ–∞–≤—ñ—Ç</option>
                    <option value="rating">‚≠êÔ∏è –†–µ–π—Ç–∏–Ω–≥ IMDb</option>
                </select>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex flex-wrap gap-4 md:gap-8 border-b border-white/5 mb-6 no-scrollbar overflow-x-auto">
            <button onclick="setTab('watching')" id="tab-watching" class="pb-2 border-b-2 border-blue-500 text-blue-500 text-[10px] font-black uppercase tracking-widest whitespace-nowrap">
                –î–∏–≤–ª—é—Å—è <span class="tab-counter" id="count-watching">(0)</span>
            </button>
            <button onclick="setTab('planning')" id="tab-planning" class="pb-2 border-b-2 border-transparent text-gray-500 text-[10px] font-black uppercase tracking-widest hover:text-white whitespace-nowrap">
                –ü–ª–∞–Ω–∏ <span class="tab-counter" id="count-planning">(0)</span>
            </button>
            <button onclick="setTab('watched')" id="tab-watched" class="pb-2 border-b-2 border-transparent text-gray-500 text-[10px] font-black uppercase tracking-widest hover:text-white whitespace-nowrap">
                –ê—Ä—Ö—ñ–≤ <span class="tab-counter" id="count-watched">(0)</span>
            </button>
            <button onclick="setTab('all')" id="tab-all" class="pb-2 border-b-2 border-transparent text-gray-500 text-[10px] font-black uppercase tracking-widest hover:text-white whitespace-nowrap">
                –£—Å—ñ <span class="tab-counter" id="count-all">(0)</span>
            </button>
            <button onclick="setTab('trends')" id="tab-trends" class="pb-2 border-b-2 border-transparent text-amber-500/70 text-[10px] font-black uppercase tracking-widest hover:text-amber-500 whitespace-nowrap">
                üî• –¢—Ä–µ–Ω–¥–∏
            </button>
        </div>

        <div id="gallery" class="flex flex-col gap-2"></div>
        <div id="emptyState" class="hidden text-center py-20 text-gray-600">
            <p class="text-sm font-bold uppercase tracking-widest">–¢—É—Ç –ø–æ–∫–∏ –ø–æ—Ä–æ–∂–Ω—å–æ</p>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black/95 z-[200] hidden items-center justify-center p-4 backdrop-blur-md">
        <div class="glass w-full max-w-3xl max-h-[85vh] rounded-3xl overflow-hidden shadow-2xl flex flex-col scale-95 transition-transform duration-200" id="modalContainer">
            <div class="p-6 md:p-8 overflow-y-auto no-scrollbar" id="modalContent"></div>
            <div class="p-4 border-t border-white/5 flex justify-between items-center">
                <div id="modalActions" class="flex gap-2"></div>
                <button onclick="closeModal()" class="px-6 py-2 bg-white text-black font-black rounded-xl hover:bg-gray-200 transition text-[10px] uppercase tracking-widest">–ó–∞–∫—Ä–∏—Ç–∏</button>
            </div>
        </div>
    </div>

    <script>
        let myShows = JSON.parse(localStorage.getItem('streamTrack_shows')) || [];
        let appPassword = localStorage.getItem('streamTrack_pass');
        let currentTab = 'watching';
        const TVMAZE_API = 'https://api.tvmaze.com';

        window.onload = () => {
            if (!appPassword) {
                document.getElementById('authMessage').innerText = "–°—Ç–≤–æ—Ä—ñ—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è –ø–µ—Ä—à–æ–≥–æ –≤—Ö–æ–¥—É";
            }
        };

        // --- Authentication System ---
        function handleAuth() {
            const input = document.getElementById('passwordInput').value;
            const error = document.getElementById('authError');
            
            if (!appPassword) {
                // First time setup
                if (input.length < 4) {
                    alert('–ü–∞—Ä–æ–ª—å –º–∞—î –±—É—Ç–∏ –Ω–µ –º–µ–Ω—à–µ 4 —Å–∏–º–≤–æ–ª—ñ–≤');
                    return;
                }
                localStorage.setItem('streamTrack_pass', input);
                appPassword = input;
                unlockApp();
            } else {
                if (input === appPassword) {
                    unlockApp();
                } else {
                    error.classList.remove('hidden');
                    setTimeout(() => error.classList.add('hidden'), 2000);
                }
            }
        }

        function unlockApp() {
            document.getElementById('authScreen').classList.add('hidden');
            const main = document.getElementById('mainApp');
            main.classList.remove('pointer-events-none');
            main.classList.replace('opacity-0', 'opacity-100');
            updateCounters();
            renderGallery();
            setupSearch();
        }

        function logout() {
            window.location.reload();
        }

        // --- Core App Logic ---
        function updateCounters() {
            const counts = {
                watching: myShows.filter(s => s.userStatus === 'üëÄ –î–∏–≤–ª—é—Å—å').length,
                planning: myShows.filter(s => s.userStatus === '‚è≥ –£ –ø–ª–∞–Ω–∞—Ö').length,
                watched: myShows.filter(s => s.userStatus === '‚úÖ –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ').length,
                all: myShows.length
            };
            for (const key in counts) {
                const el = document.getElementById(`count-${key}`);
                if (el) el.innerText = `(${counts[key]})`;
            }
        }

        function setTab(tab) {
            currentTab = tab;
            document.querySelectorAll('button[id^="tab-"]').forEach(b => {
                b.classList.remove('border-blue-500', 'text-blue-500');
                b.classList.add('border-transparent', 'text-gray-500');
            });
            document.getElementById(`tab-${tab}`).classList.add('border-blue-500', 'text-blue-500');
            if (tab === 'trends') loadTrends(); else renderGallery();
        }

        async function loadTrends() {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '<div class="text-center py-10 text-xs font-bold text-gray-500 animate-pulse uppercase tracking-widest">–û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É —Ç—Ä–µ–Ω–¥—ñ–≤...</div>';
            
            try {
                const pages = [0, 1]; 
                const responses = await Promise.all(pages.map(p => fetch(`${TVMAZE_API}/shows?page=${p}`)));
                const datasets = await Promise.all(responses.map(r => r.json()));
                let allData = datasets.flat().sort((a, b) => (b.rating.average || 0) - (a.rating.average || 0));

                const myIds = new Set(myShows.map(s => s.id));
                const filteredTrends = allData.filter(show => !myIds.has(show.id)).slice(0, 100);

                gallery.innerHTML = filteredTrends.map(show => `
                    <div class="card-row glass rounded-2xl flex items-center p-3 gap-4">
                        <img src="${show.image?.medium || ''}" class="w-10 h-14 object-cover rounded-lg shadow-lg shrink-0 grayscale hover:grayscale-0 transition-all">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-sm text-white truncate">${show.name}</span>
                                <span class="text-[9px] font-bold text-amber-500">IMDb ${show.rating.average || 'N/A'}</span>
                            </div>
                            <div class="text-[10px] text-gray-500 uppercase font-bold tracking-tighter">${show.genres.slice(0,2).join(' ‚Ä¢ ') || '–°–µ—Ä—ñ–∞–ª'}</div>
                        </div>
                        <button onclick="addShow(${show.id}, true)" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest transition shrink-0">–î–æ–¥–∞—Ç–∏</button>
                    </div>
                `).join('');
            } catch (err) { 
                gallery.innerHTML = '<div class="text-center py-10 text-red-500 font-bold uppercase text-[10px]">–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º</div>'; 
            }
        }

        function setupSearch() {
            const input = document.getElementById('searchInput');
            const resultsDiv = document.getElementById('searchResults');
            input.addEventListener('input', async (e) => {
                const query = e.target.value;
                if (query.length < 3) { resultsDiv.classList.add('hidden'); return; }
                try {
                    const res = await fetch(`${TVMAZE_API}/search/shows?q=${query}`);
                    const data = await res.json();
                    resultsDiv.innerHTML = data.map(item => `
                        <div onclick="addShow(${item.show.id})" class="p-3 hover:bg-white/10 cursor-pointer flex gap-3 border-b border-white/5 last:border-0">
                            <img src="${item.show.image?.medium || ''}" class="w-8 h-10 object-cover rounded shadow">
                            <div>
                                <div class="font-bold text-xs text-white">${item.show.name}</div>
                                <div class="text-[9px] text-gray-500 uppercase">${item.show.status}</div>
                            </div>
                        </div>
                    `).join('');
                    resultsDiv.classList.remove('hidden');
                } catch (err) { console.error(err); }
            });
        }

        async function addShow(id, fromTrends = false) {
            if (myShows.find(s => s.id === id)) return;
            const res = await fetch(`${TVMAZE_API}/shows/${id}?embed=episodes`);
            const show = await res.json();
            const newShow = {
                id: show.id, 
                name: show.name, 
                image: show.image?.medium, 
                imdb: show.rating.average, 
                imdbId: show.externals?.imdb,
                officialStatus: show.status, 
                userStatus: '‚è≥ –£ –ø–ª–∞–Ω–∞—Ö',
                dateAdded: Date.now(),
                currentEpisodeCount: 0, 
                totalEpisodes: show._embedded.episodes.length,
                lastAirDate: show._embedded.episodes[show._embedded.episodes.length-1]?.airdate || '',
                episodes: show._embedded.episodes.map(e => ({ id: e.id, name: e.name, season: e.season, number: e.number, airdate: e.airdate, watched: false }))
            };
            myShows.push(newShow); 
            save(); 
            updateCounters();
            if (fromTrends) loadTrends(); else {
                renderGallery();
                document.getElementById('searchResults').classList.add('hidden');
                document.getElementById('searchInput').value = '';
            }
        }

        function renderGallery() {
            const gallery = document.getElementById('gallery');
            const emptyState = document.getElementById('emptyState');
            let filtered = [...myShows];

            switch(currentTab) {
                case 'watching': filtered = filtered.filter(s => s.userStatus === 'üëÄ –î–∏–≤–ª—é—Å—å'); break;
                case 'planning': filtered = filtered.filter(s => s.userStatus === '‚è≥ –£ –ø–ª–∞–Ω–∞—Ö'); break;
                case 'watched': filtered = filtered.filter(s => s.userStatus === '‚úÖ –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ'); break;
            }
            
            const sortVal = document.getElementById('sortOrder').value;
            if (sortVal === 'dateAdded') filtered.sort((a, b) => (b.dateAdded || 0) - (a.dateAdded || 0));
            else if (sortVal === 'newest') filtered.sort((a, b) => new Date(b.lastAirDate) - new Date(a.lastAirDate));
            else if (sortVal === 'alphabet') filtered.sort((a, b) => a.name.localeCompare(b.name));
            else if (sortVal === 'rating') filtered.sort((a, b) => (b.imdb || 0) - (a.imdb || 0));

            if (filtered.length === 0) { gallery.innerHTML = ''; emptyState.classList.remove('hidden'); return; }
            emptyState.classList.add('hidden');

            gallery.innerHTML = filtered.map(show => `
                <div class="card-row glass rounded-2xl flex items-center p-3 gap-4 cursor-pointer" onclick="openModal(${show.id})">
                    <img src="${show.image || ''}" class="w-10 h-14 object-cover rounded-lg shrink-0 grayscale hover:grayscale-0 transition-all">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-bold text-sm text-white truncate">${show.name}</span>
                            <span class="status-pill bg-white/5 text-gray-400 border border-white/10">${show.officialStatus}</span>
                        </div>
                        <div class="flex items-center gap-3 text-[9px] text-gray-500 font-bold uppercase tracking-tighter">
                            <span class="text-blue-400">${show.userStatus}</span>
                            <span class="text-blue-500">${show.currentEpisodeCount} / ${show.totalEpisodes} —Å–µ—Ä—ñ–π</span>
                        </div>
                        <div class="w-full h-1 bg-white/5 rounded-full mt-2 overflow-hidden">
                            <div class="h-full bg-blue-600 transition-all" style="width: ${(show.currentEpisodeCount/show.totalEpisodes)*100}%"></div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openModal(id) {
            const show = myShows.find(s => s.id === id);
            if (!show) return;
            const modal = document.getElementById('modal');
            const content = document.getElementById('modalContent');
            const actions = document.getElementById('modalActions');
            
            const seasons = {};
            show.episodes.forEach((ep, idx) => {
                if (!seasons[ep.season]) seasons[ep.season] = [];
                seasons[ep.season].push({ ...ep, originalIdx: idx });
            });

            const seasonsHtml = Object.keys(seasons).map(num => `
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2 px-1">
                        <h4 class="text-[10px] font-black uppercase text-blue-500 tracking-widest">–°–µ–∑–æ–Ω ${num}</h4>
                        <button onclick="toggleSeason(${show.id}, ${num}, true)" class="text-[8px] font-bold text-gray-500 hover:text-white uppercase">–í–∏–±—Ä–∞—Ç–∏ –≤—Å–µ</button>
                    </div>
                    <div class="grid grid-cols-1 gap-1">
                        ${seasons[num].map(ep => `
                            <div class="flex items-center gap-3 p-2 hover:bg-white/5 rounded-xl transition ${ep.watched ? 'opacity-30' : ''}">
                                <input type="checkbox" ${ep.watched ? 'checked' : ''} onchange="toggleEpisode(${show.id}, ${ep.originalIdx})" class="w-4 h-4 rounded border-white/10 bg-white/5 text-blue-600 focus:ring-0">
                                <span class="text-xs font-bold text-white flex-1">${ep.name}</span>
                                <span class="text-[9px] font-mono text-gray-600">${ep.airdate}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            content.innerHTML = `
                <div class="mb-8">
                    <h2 class="text-3xl font-black text-white mb-2 tracking-tighter">${show.name}</h2>
                    <div class="flex gap-4 text-[10px] text-gray-500 font-bold uppercase tracking-widest">
                        <span>IMDb ${show.imdb || 'N/A'}</span>
                        <span>${show.totalEpisodes} —Å–µ—Ä—ñ–π</span>
                        <span>${show.officialStatus}</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                    <div class="glass p-5 rounded-2xl">
                        <p class="text-[9px] font-black text-gray-500 uppercase mb-2 tracking-widest">–¢–≤—ñ–π —Å—Ç–∞—Ç—É—Å</p>
                        <select onchange="updateShow(${show.id}, 'userStatus', this.value)" class="w-full bg-transparent text-sm font-bold text-white focus:outline-none cursor-pointer">
                            <option value="üëÄ –î–∏–≤–ª—é—Å—å" ${show.userStatus === 'üëÄ –î–∏–≤–ª—é—Å—å' ? 'selected' : ''}>üëÄ –î–∏–≤–ª—é—Å—å</option>
                            <option value="‚úÖ –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ" ${show.userStatus === '‚úÖ –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ' ? 'selected' : ''}>‚úÖ –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ</option>
                            <option value="‚è≥ –£ –ø–ª–∞–Ω–∞—Ö" ${show.userStatus === '‚è≥ –£ –ø–ª–∞–Ω–∞—Ö' ? 'selected' : ''}>‚è≥ –£ –ø–ª–∞–Ω–∞—Ö</option>
                            <option value="üõë –ü–æ–∫–∏–Ω—É—Ç–æ" ${show.userStatus === 'üõë –ü–æ–∫–∏–Ω—É—Ç–æ' ? 'selected' : ''}>üõë –ü–æ–∫–∏–Ω—É—Ç–æ</option>
                        </select>
                    </div>
                    <div class="glass p-5 rounded-2xl">
                        <p class="text-[9px] font-black text-gray-500 uppercase mb-2 tracking-widest">–ü—Ä–æ–≥—Ä–µ—Å</p>
                        <div class="text-xl font-black text-blue-500">${show.currentEpisodeCount} / ${show.totalEpisodes}</div>
                    </div>
                </div>

                <div class="glass rounded-2xl p-4 overflow-hidden">
                    <div class="max-h-[300px] overflow-y-auto pr-2 no-scrollbar">${seasonsHtml}</div>
                </div>
            `;
            actions.innerHTML = `<button onclick="removeShow(${show.id})" class="px-4 py-2 text-red-500 text-[9px] font-black uppercase hover:bg-red-500/10 rounded-xl transition">–í–∏–¥–∞–ª–∏—Ç–∏</button>`;
            modal.classList.replace('hidden', 'flex');
            setTimeout(() => document.getElementById('modalContainer').classList.replace('scale-95', 'scale-100'), 10);
        }

        function closeModal() {
            document.getElementById('modalContainer').classList.replace('scale-100', 'scale-95');
            setTimeout(() => { document.getElementById('modal').classList.replace('flex', 'hidden'); renderGallery(); }, 150);
        }

        function toggleEpisode(showId, epIdx) {
            const show = myShows.find(s => s.id === showId);
            show.episodes[epIdx].watched = !show.episodes[epIdx].watched;
            show.currentEpisodeCount = show.episodes.filter(e => e.watched).length;
            save(); openModal(showId);
        }

        function toggleSeason(showId, seasonNum, watched) {
            const show = myShows.find(s => s.id === showId);
            show.episodes.forEach(ep => { if (ep.season == seasonNum) ep.watched = watched; });
            show.currentEpisodeCount = show.episodes.filter(e => e.watched).length;
            save(); openModal(showId);
        }

        function updateShow(id, field, value) {
            const show = myShows.find(s => s.id === id);
            show[field] = value; 
            save(); updateCounters();
        }

        function removeShow(id) {
            if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Å–µ—Ä—ñ–∞–ª?')) {
                myShows = myShows.filter(s => s.id !== id);
                save(); updateCounters(); closeModal();
            }
        }

        function save() { localStorage.setItem('streamTrack_shows', JSON.stringify(myShows)); }

        function exportData() {
            const dateStr = new Date().toISOString().split('T')[0];
            const blob = new Blob([JSON.stringify(myShows, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url;
            a.download = `streamtrack_backup_${dateStr}.json`; a.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try { 
                    const data = JSON.parse(e.target.result);
                    myShows = data.map(s => ({...s, dateAdded: s.dateAdded || Date.now()}));
                    save(); updateCounters(); renderGallery(); 
                    alert('–ë–∞–∑—É –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ');
                } catch (err) { alert('–ü–æ–º–∏–ª–∫–∞ —Ñ–∞–π–ª—É'); }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
