<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, doc, setDoc, deleteDoc, collection, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBI72wYVkWPnU6IShQA0GzNv2qxkSwPjxc",
  authDomain: "raf-serials.firebaseapp.com",
  projectId: "raf-serials",
  storageBucket: "raf-serials.firebasestorage.app",
  messagingSenderId: "908671765741",
  appId: "1:908671765741:web:bc0573e464c69ec90d90e4",
  measurementId: "G-4RX35LRNFF"
};

const fbApp = initializeApp(firebaseConfig);
const auth = getAuth(fbApp);
const db = getFirestore(fbApp);
const provider = new GoogleAuthProvider();

let user = null;
let unsub = null;

// Кнопки логіну (працюють з твоїм inline onclick стилем)
window.login = () => signInWithPopup(auth, provider);
window.logout = () => signOut(auth);

// Вставляємо кнопки в хедер
document.addEventListener("DOMContentLoaded", () => {
  const headerRight = document.querySelector("header .flex.items-center.gap-2");
  if (headerRight) {
    const wrap = document.createElement("div");
    wrap.className = "flex items-center gap-2 mr-2";
    wrap.innerHTML = `
      <button onclick="login()" class="glass px-3 py-2 rounded-lg text-[10px] font-black hover:bg-white/10 transition uppercase">Увійти</button>
      <button onclick="logout()" id="logoutBtn" class="glass px-3 py-2 rounded-lg text-[10px] font-black hover:bg-white/10 transition uppercase hidden">Вийти</button>
      <span id="userEmail" class="text-[10px] text-gray-500 font-bold hidden"></span>
    `;
    headerRight.parentNode.insertBefore(wrap, headerRight);
  }
});

// Підписка на хмарні дані
function startSync() {
  const ref = collection(db, "users", user.uid, "shows");
  unsub = onSnapshot(ref, (snap) => {
    // Перезаписуємо локальний список з хмари
    window.myShows = snap.docs.map(d => d.data());
    localStorage.setItem("streamTrack_shows", JSON.stringify(window.myShows));

    // Оновлення UI (твої функції існують у великому скрипті)
    window.updateCounters?.();
    window.renderGallery?.();
  });
}

async function upsertShow(show) {
  if (!user) return;
  await setDoc(
    doc(db, "users", user.uid, "shows", String(show.id)),
    { ...show, updatedAt: serverTimestamp() }
  );
}

async function removeShowCloud(id) {
  if (!user) return;
  await deleteDoc(doc(db, "users", user.uid, "shows", String(id)));
}

// Патчимо твій save(): після локального save — синкаємо в хмару
const originalSave = window.save;
window.save = function () {
  originalSave?.();
  // якщо є активний серіал у модалці — нічого, ми синкаємо на подіях нижче
  // (але надійніше синкати при кожній зміні)
};

// Патчимо ключові дії: коли ти змінюєш серії/статус — після цього викликаємо upsert
// Для цього перехоплюємо твої функції і додаємо синк
["toggleEpisode","toggleSeason","updateShowStatus","addShow"].forEach(fnName => {
  const orig = window[fnName];
  if (typeof orig === "function") {
    window[fnName] = async function (...args) {
      const r = await orig.apply(this, args);

      // пробуємо синкнути останній змінений серіал
      // (беремо його з myShows по showId або id)
      try {
        const id = args[0];
        const show = (window.myShows || []).find(s => s.id === id);
        if (show) await upsertShow(show);
      } catch {}
      return r;
    };
  }
});

const originalRemoveShow = window.removeShow;
window.removeShow = async function(id) {
  await originalRemoveShow?.(id);
  await removeShowCloud(id);
};

// Auth state
onAuthStateChanged(auth, (u) => {
  user = u || null;

  const logoutBtn = document.getElementById("logoutBtn");
  const userEmail = document.getElementById("userEmail");
  if (logoutBtn) logoutBtn.classList.toggle("hidden", !user);
  if (userEmail) {
    userEmail.classList.toggle("hidden", !user);
    userEmail.textContent = user ? user.email : "";
  }

  if (unsub) { unsub(); unsub = null; }

  if (user) startSync();
});
</script>
